<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نبض سبز - برنامه مراقبت از گیاه</title>
    
    <!-- PWA: لینک به manifest.json -->
    <link rel="manifest" href="./manifest.json">
    <!-- PWA: تنظیم رنگ نوار وضعیت برای مرورگرهای موبایل -->
    <meta name="theme-color" content="#16A34A"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- فونت Vazirmatn از Google Fonts - می‌توانید آن را حذف یا در کنار فونت دلخواه خود استفاده کنید -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        /* ------------------------------------------------------------- */
        /* تعریف فونت‌های دلخواه شما با استفاده از @font-face */
        /* فایل‌های فونت خود را در پوشه "fonts" قرار دهید. */
        /* برای هر وزن فونت (مثلاً Regular, Bold) یک @font-face جداگانه تعریف کنید. */
        /* مثال: اگر فایل فونت معمولی شما "MyCustomFont-Regular.woff2" است */
        /* نام "MyCustomFont" را می‌توانید به نام فونت دلخواه خود تغییر دهید. */
        /* ------------------------------------------------------------- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('./fonts/MyCustomFont-Regular.woff2') format('woff2'),
                 url('./fonts/MyCustomFont-Regular.woff') format('woff');
            font-weight: 400; /* وزن فونت معمولی */
            font-style: normal;
            font-display: swap; /* برای بهبود تجربه بارگذاری فونت */
        }
        @font-face {
            font-family: 'MyCustomFont';
            src: url('./fonts/MyCustomFont-Bold.woff2') format('woff2'),
                 url('./fonts/MyCustomFont-Bold.woff') format('woff');
            font-weight: 700; /* وزن فونت Bold */
            font-style: normal;
            font-display: swap;
        }
        /* ------------------------------------------------------------- */

        /* تعریف متغیرهای فونت برای بخش‌های مختلف برنامه */
        :root {
            /* می‌توانید هر کدام از اینها را به 'MyCustomFont', 'Vazirmatn', یا هر فونت دیگری که تعریف کردید تغییر دهید. */
            --font-main-title: 'Vazirmatn', sans-serif;         /* برای عنوان اصلی (h1: نبض سبز) */
            --font-section-heading: 'Vazirmatn', sans-serif;    /* برای عنوان‌های بخش‌ها (h2, h3: پاسخ نبض سبز, تاریخچه, نکته روز) */
            --font-welcome-main: 'Vazirmatn', sans-serif;        /* برای "به نبض سبز خوش آمدید!" */
            --font-welcome-sub: 'Vazirmatn', sans-serif;      /* برای "دستیار هوشمند مراقبت از گیاهان." */
            --font-body-text: 'Vazirmatn', sans-serif;          /* برای متن‌های عادی (مانند پاسخ‌ها، توضیحات ورودی) */
            --font-input-button: 'Vazirmatn', sans-serif;       /* برای ورودی‌ها، انتخاب‌ها، دکمه‌ها */

            /* سایر متغیرهای رنگی */
            --color-stone-500: '#78716c'; /* سنگی 500 - رنگ هاور پس‌زمینه دکمه‌های داخلی مودال (مثل "تولید نام") */
            --color-stone-400: '#a8a29e'; /* سنگی 400 - پس‌زمینه اصلی دکمه‌های داخلی مودال، و همچنین رنگ متن لیبل‌ها در مودال (مثال: "نام گیاه:") */
            --color-stone-510: '#234723'; /* Changed to requested color for active circular button */
            
            --color-purple-600: '#9333ea'; /* بنفش 600 - پس‌زمینه دکمه نویگیشن "شخصیت" */
            --color-purple-700: '#7e22ce'; /* بنفش 700 - رنگ هاور پس‌زمینه دکمه نویگیشن "شخصیت" */

            --color-green-500: '#22c55e'; /* سبز 500 - (این متغیر مستقیماً در CSS سفارشی استفاده نشده، اما در Tailwind موجود است) */
            --color-green-600: '#16a34a'; /* سبز 600 - پس‌زمینه دکمه‌های نویگیشن (به جز "شخصیت")، دکمه "بستن" در مودال‌ها */
            --color-green-700: '#15803d'; /* سبز 700 - رنگ هاور پس‌زمینه دکمه‌های سبز رنگ (نویگیشن و مودال) */
        }

        /* اعمال فونت‌ها به عناصر مربوطه */
        body {
            font-family: var(--font-body-text);
        }

        #homeSection { /* H1: نبض سبز */
            font-family: var(--font-main-title);
        }

        #aiResponseArea h2, #dailyTipModal h3 { /* H2 و H3: عنوان‌های بخش‌ها و مودال اصلی */
            font-family: var(--font-section-heading);
        }
        /* تغییر اندازه فونت عنوان داخل mainModal */
        #mainModal h3 {
            font-family: var(--font-section-heading);
            font-size: 1.25rem; /* text-xl معادل 20px */
        }


        #historySection h3 { /* عنوان تاریخچه - اندازه جدید */
            font-family: var(--font-section-heading);
            font-size: 1.125rem; /* text-lg in Tailwind (previously text-xl) */
        }

        .welcome-main-text {
            font-family: var(--font-welcome-main);
        }

        .welcome-sub-text {
            font-family: var(--font-welcome-sub);
            font-size: 1.125rem; /* text-lg for mobile */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .welcome-sub-text {
                font-size: 1.25rem; /* text-xl for tablet and desktop */
            }
        }

        button, input, select, textarea, .history-item { /* دکمه‌ها، ورودی‌ها، آیتم‌های تاریخچه و متن‌های عادی */
            font-family: var(--font-input-button);
        }

        /* تغییر رنگ متن لیبل‌ها در مودال به رنگ پس‌زمینه دکمه‌ها (نسکافه‌ای روشن‌تر) */
        .text-stone-custom { color: var(--color-stone-400); } 
        .bg-stone-510 { background-color: var(--color-stone-510); }
        .bg-stone-400 { background-color: var(--color-stone-400); }
        .hover\:bg-stone-500:hover { background-color: var(--color-stone-500); }

        .bg-purple-custom-600 { background-color: var(--color-purple-600); }
        .hover\:bg-purple-custom-700:hover { background-color: var(--color-purple-700); }

        /* General Modal Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
        
        .modal-content-animate-in {
            opacity: 1 !important;
            transform: scale(1) !important;
        }
        .modal-content-animate-out {
            opacity: 0 !important;
            transform: scale(0.95) !important;
        }
        .modal-background-fade-in {
            opacity: 1 !important;
        }
        .modal-background-fade-out {
            opacity: 0 !important;
        }


        /* استایل برای آیتم‌های تاریخچه */
        .history-item {
            background-color: #ffffff; /* bg-white */
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-sm */
            margin-bottom: 0.75rem; /* mb-3 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .history-item:last-child {
            margin-bottom: 0;
        }
        .history-item-question {
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* text-gray-700 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .history-item-response {
            color: #6b7280; /* text-gray-600 */
            line-height: 1.6;
        }

        /* سبک‌های دکمه‌های آیکونی دایره‌ای */
        .icon-nav-button {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 5rem; /* w-20 (80px) for mobile */
            height: 5rem; /* h-20 (80px) for mobile */
            border-radius: 9999px; /* کاملاً دایره‌ای */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            transition: all 0.3s ease-in-out;
            transform: scale(1);
            padding: 0; /* padding را حذف می کنیم تا آیکون تمام فضای دایره را بگیرد */
            overflow: hidden; /* برای اطمینان از برش دایره ای تصویر */
            background-color: #D6E0C7; /* رنگ پس‌زمینه درخواست شده */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .icon-nav-button {
                width: 6rem; /* md:w-24 (96px) for tablet and desktop */
                height: 6rem; /* md:h-24 (96px) for tablet and desktop */
            }
        }
        .icon-nav-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #C6D4B9; /* کمی تیره‌تر برای هاور */
        }
        .icon-nav-button.active {
            background-color: var(--color-stone-510) !important; /* رنگ فعال */
            transform: scale(1.05);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .icon-nav-button img {
            width: 100%; /* آیکون کل عرض دایره را پر می‌کند */
            height: 100%; /* آیکون کل ارتفاع دایره را پر می‌کند */
            object-fit: cover; /* تصویر را برش می‌دهد تا در دایره جا شود و نسبت ابعاد را حفظ کند */
            border-radius: 9999px; /* تصویر را به صورت دایره‌ای برش می‌دهد */
            flex-shrink: 0; 
        }
        /* کلاس برای متن زیر آیکون */
        .icon-nav-label {
            font-size: 0.875rem; /* text-sm معادل 14px */
            line-height: 1.25rem; /* leading-tight */
            font-weight: 500; /* font-medium */
            display: block; 
            white-space: normal; 
            color: #374151; /* text-gray-700 */
            margin-top: 0.25rem; /* فاصله بین دکمه دایره‌ای و متن */
        }
        .icon-nav-button.active + .icon-nav-label { /* وقتی دکمه فعال است، متن زیرش سفید شود */
             color: white; 
        }

        /* چیدمان گرید برای دکمه‌های نویگیشن */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 ستون در موبایل و بزرگتر */
            gap: 1rem; /* فاصله بین دکمه‌ها */
            justify-items: center; /* تراز کردن دکمه‌ها در مرکز ستون‌ها */
        }

        .nav-item-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none; 
            color: inherit; 
            width: 100%; /* اطمینان از اینکه wrapper عرض خود را در grid بگیرد */
        }
        /* بخش‌های محتوا که قرار است به داخل مودال بروند، در اینجا پنهان می مانند.
           فقط با JS در modalContentArea قرار می گیرند. */
        .section-content-hidden-source {
            display: none !important; /* Ensure this is always hidden by default */
        }

        /* Styles for the new horizontal tab bar */
        .horizontal-tab-bar {
            background-color: #D6E0C7;
            /* border: 1px solid #dcfce7; */ /* Border removed */
        }
        .horizontal-tab-bar .tab-button {
            background-color: transparent;
            color: #69735A; /* Reverted to 69735A */
            font-weight: 600; /* font-semibold */
            padding: 0.5rem 1.5rem; /* py-2 px-6 */
            border-radius: 9999px; /* rounded-full */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* Prevent wrapping */
        }
        .horizontal-tab-bar .tab-button.active {
            background-color: #234723; /* Background active changed to 234723 */
            color: #C5EABF; /* Text color active changed to C5EABF */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* subtle shadow for active tab */
        }
        .horizontal-tab-bar .tab-button:hover:not(.active) {
            background-color: #bbf7d0; /* green-200 for hover on inactive */
        }

    </style>
</head>
<body class="min-h-screen p-4" style="background-color: #E8ECDE;">

    <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-11/12 md:max-w-lg px-4 py-3 rounded-md shadow-xl text-white text-center" style="display: none;">
        <p id="messageBoxText" class="font-bold text-base"></p>
    </div>

    <div class="max-w-4xl mx-auto pt-2 px-4">
        <h1 id="homeSection" class="text-3xl md:text-4xl font-extrabold text-center text-green-800 mb-4 tracking-tight drop-shadow-md flex items-center justify-center gap-3">
            <!-- آیکون کنار اسم "نبض سبز" - اندازه: w-10 h-10 (40x40px) -->
            <img src="./images/plant-icon.png" alt="آیکون گیاه" class="w-10 h-10">
            نبض سبز
        </h1>

        <!-- NEW: Horizontal Tab Bar -->
        <div id="horizontalTabs" class="flex justify-around items-center horizontal-tab-bar rounded-full py-2 px-1 mb-8 shadow-sm">
            <button id="dailyTipTab" class="tab-button active">
                نکته روز
            </button>
            <button id="historyMainTab" class="tab-button">
                تاریخچه
            </button>
        </div>

        <!-- نویگیشن بار جدید با دکمه‌های دایره‌ای آیکونی -->
        <nav class="w-full p-4 rounded-2xl mb-10" style="background-color: #D6E0C7;">
            <div class="nav-grid">
                <!-- دکمه شخصیت گیاه -->
                <div class="nav-item-wrapper">
                    <button data-section="nickname" data-full-title="نام مستعار/شخصیت گیاه" class="nav-button icon-nav-button">
                        <img src="./images/sparkles-icon.png" alt="آیکون شخصیت گیاه">
                    </button>
                    <span class="icon-nav-label">شخصیت</span>
                </div>

                <!-- دکمه شناسایی گیاه -->
                <div class="nav-item-wrapper">
                    <button data-section="identify" data-full-title="شناسایی گیاه از روی عکس" class="nav-button icon-nav-button">
                        <img src="./images/camera-icon.png" alt="آیکون شناسایی گیاه">
                    </button>
                    <span class="icon-nav-label">شناسایی</span>
                </div>

                <!-- دکمه اطلاعات گیاهان -->
                <div class="nav-item-wrapper">
                    <button data-section="info" data-full-title="اطلاعات گیاهان" class="nav-button icon-nav-button">
                        <img src="./images/info-icon.png" alt="آیکون اطلاعات گیاهان">
                    </button>
                    <span class="icon-nav-label">اطلاعات</span>
                </div>
                
                <!-- دکمه مراقبت از گیاه -->
                <div class="nav-item-wrapper">
                    <button data-section="careSchedule" data-full-title="برنامه مراقبت از گیاه" class="nav-button icon-nav-button">
                        <img src="./images/calendar-icon.png" alt="آیکون مراقبت از گیاه">
                    </button>
                    <span class="icon-nav-label">مراقبت</span>
                </div>

                <!-- دکمه درمان گیاه -->
                <div class="nav-item-wrapper">
                    <button data-section="troubleshoot" data-full-title="عیب‌یابی و درمان گیاه" class="nav-button icon-nav-button">
                        <img src="./images/heart-crack-icon.png" alt="آیکون درمان گیاه">
                    </button>
                    <span class="icon-nav-label">درمان</span>
                </div>
            </div>
        </nav>

        <!-- بخش AI Response و Loading/Error -->
        <div id="aiResponseArea" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mt-8 mb-10" style="display: none;">
            <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center justify-center gap-2">
                <!-- آیکون کنار "پاسخ نبض سبز" - اندازه: w-7 h-7 (28x28px) -->
                <img src="./images/response-lightbulb-icon.png" alt="آیکون پاسخ" class="w-7 h-7">
                پاسخ نبض سبز
            </h2>
            <div id="aiResponseContent" class="prose prose-lg max-w-none text-gray-800 leading-relaxed"></div>
        </div>

        <div id="loadingIndicator" class="text-center text-green-700 text-lg font-semibold mt-4 flex items-center justify-center gap-2" style="display: none;">
            <svg class="animate-spin h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            در حال بارگذاری...
        </div>
        <div id="errorIndicator" class="text-center text-red-600 text-lg font-semibold mt-4" style="display: none;"></div>
    </div>

    <!-- این div ها باید خارج از mainModal و به عنوان فرزند body باشند، اما برای راحتی در اینجا تعریف میشوند
         و با جاوااسکریپت مدیریت میشوند. کلاس section-content-hidden-source آنها را پنهان نگه میدارد. -->
    <div id="nicknameSection" class="section-content-hidden-source">
        <div class="mb-6">
            <label for="plantNameNickname" class="block text-lg font-semibold mb-2 text-stone-custom">نام گیاه را وارد کنید:</label>
            <input type="text" id="plantNameNickname" placeholder="مثال: سانسوریا، پتوس" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right placeholder-gray-400 text-gray-700">
        </div>
        <button id="generateNicknameButton" class="w-full bg-stone-400 hover:bg-stone-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-opacity-75">تولید نام</button>
    </div>
    
    <div id="identifySection" class="section-content-hidden-source">
        <div class="mb-6">
            <label for="imageUpload" class="block text-lg font-semibold mb-2 text-stone-custom">تصویر گیاه را آپلود کنید:</label>
            <input type="file" id="imageUpload" accept="image/*" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
        </div>
        <div id="imagePreviewContainer" class="mb-6 text-center" style="display: none;">
            <p class="text-gray-600 mb-2">پیش‌نمایش تصویر:</p>
            <img id="imagePreview" src="#" alt="Plant Preview" class="max-w-full h-auto rounded-lg shadow-md mx-auto" style="max-height: 300px;">
        </div>
        <button id="identifyPlantButton" class="w-full bg-stone-400 hover:bg-stone-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-opacity-75">شناسایی گیاه</button>
    </div>

    <div id="infoSection" class="section-content-hidden-source">
        <div class="mb-6">
            <label for="plantNameInfo" class="block text-lg font-semibold mb-2 text-stone-custom">نام گیاه را وارد کنید:</label>
            <input type="text" id="plantNameInfo" placeholder="مثال: زاموفیلیا، فیکوس" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right placeholder-gray-400 text-gray-700">
        </div>
        <button id="getPlantInfoButton" class="w-full bg-stone-400 hover:bg-stone-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-opacity-75">دریافت اطلاعات</button>
    </div>
    
    <div id="careScheduleSection" class="section-content-hidden-source">
        <div class="mb-6">
            <label for="schedulePlantName" class="block text-lg font-semibold mb-2 text-stone-custom">نام گیاه را وارد کنید:</label>
            <input type="text" id="schedulePlantName" placeholder="مثال: ارکیده، کاکتوس" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right placeholder-gray-400 text-gray-700">
        </div>
        <div class="mb-6">
            <label for="careFrequency" class="block text-lg font-semibold mb-2 text-stone-custom">دوره مراقبت را انتخاب کنید:</label>
            <select id="careFrequency" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right text-gray-700">
                <option value="روزانه">روزانه</option>
                <option value="هفتگی" selected>هفتگی</option>
                <option value="دو هفته یکبار">دو هفته یکبار</option>
                <option value="ماهانه">ماهانه</option>
                <option value="فصلی">فصلی</option>
            </select>
        </div>
        <button id="generateCareScheduleButton" class="w-full bg-stone-400 hover:bg-stone-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-opacity-75">تولید برنامه مراقبت</button>
    </div>

    <div id="troubleshootSection" class="section-content-hidden-source">
        <div class="mb-6">
            <label for="plantNameTroubleshoot" class="block text-lg font-semibold mb-2 text-stone-custom">نام گیاه را وارد کنید:</label>
            <input type="text" id="plantNameTroubleshoot" placeholder="مثال: حسن یوسف" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right placeholder-gray-400 text-gray-700">
        </div>
        <div class="mb-6">
            <label for="plantProblem" class="block text-lg font-semibold mb-2 text-stone-custom">مشکل گیاه را توضیح دهید:</label>
            <textarea id="plantProblem" placeholder="مثال: برگ‌های زرد، پژمردگی، لکه‌های قهوه‌ای" rows="3" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-right placeholder-gray-400 text-gray-700 resize-y"></textarea>
        </div>
        <button id="solvePlantProblemButton" class="w-full bg-stone-400 hover:bg-stone-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-opacity-75">یافتن راه حل</button>
    </div>

    <div id="historySection" class="section-content-hidden-source">
        <h3 class="text-lg font-bold text-green-700 mb-4">تاریخچه درخواست‌ها</h3>
        <div id="historyList" class="flex flex-col gap-3">
            <p class="text-gray-600 text-center" id="emptyHistoryMessage">
                هنوز درخواستی ثبت نشده است.
            </p>
        </div>
        <button id="clearHistoryButton" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75" style="display:none;">
            پاک کردن تاریخچه
        </button>
    </div>

    <!-- Main Modal Structure for Section Inputs -->
    <div id="mainModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300" style="display: none; opacity: 0;">
        <div id="mainModalContent" class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center transition-all duration-300 ease-out transform opacity-0 scale-95">
            <h3 id="modalTitle" class="text-xl font-extrabold text-green-700 mb-6 flex items-center justify-center gap-2">
                <!-- Dynamic Title Here -->
            </h3>
            <div id="modalContentArea" class="text-right">
                <!-- Section content will be dynamically loaded here -->
            </div>
            <button id="closeMainModalButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 mt-6">
                بستن
            </button>
        </div>
    </div>

    <!-- Daily Tip Modal (remains separate) -->
    <div id="dailyTipModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300" style="display: none; opacity: 0;">
        <div id="dailyTipModalContent" class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center transition-all duration-300 ease-out transform opacity-0 scale-95">
            <h3 class="text-3xl font-extrabold text-green-700 mb-4 flex items-center justify-center gap-2">
                <!-- آیکون داخل مودال "نکته روز گیاهی" - اندازه: w-8 h-8 (32x32px) -->
                <img src="./images/modal-lightbulb-icon.png" alt="آیکون نکته" class="w-8 h-8">
                نکته روز گیاهی
            </h3>
            <p id="dailyTipText" class="text-lg text-gray-800 leading-relaxed mb-6"></p>
            <button id="closeDailyTipModalButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                بستن
            </button>
        </div>
    </div>

    <script>
        (function() {
            // State variables
            let currentActiveSection = null; // For circular nav modals
            let currentActiveTab = 'dailyTip'; // For horizontal tabs: 'dailyTip' or 'history'
            let loading = false;
            let imageDataBase64 = null; 
            let messageBoxTimeout;
            let history = JSON.parse(localStorage.getItem('plantCareHistory')) || [];

            // DOM Elements
            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            
            const homeSection = document.getElementById('homeSection');
            const navButtons = document.querySelectorAll('.nav-button'); // Circular buttons
            const contentSections = { 
                nickname: document.getElementById('nicknameSection'),
                identify: document.getElementById('identifySection'),
                info: document.getElementById('infoSection'),
                careSchedule: document.getElementById('careScheduleSection'),
                troubleshoot: document.getElementById('troubleshootSection'),
                history: document.getElementById('historySection') 
            };

            // Main Modal elements (for circular buttons)
            const mainModal = document.getElementById('mainModal');
            const mainModalContent = document.getElementById('mainModalContent');
            const modalTitle = document.getElementById('modalTitle');
            const modalContentArea = document.getElementById('modalContentArea');
            const closeMainModalButton = document.getElementById('closeMainModalButton');

            // Daily Tip Modal elements
            const dailyTipModal = document.getElementById('dailyTipModal');
            const dailyTipModalContent = document.getElementById('dailyTipModalContent');
            const dailyTipText = document.getElementById('dailyTipText');
            const closeDailyTipModalButton = document.getElementById('closeDailyTipModalButton');

            // Horizontal Tab Elements
            const dailyTipTab = document.getElementById('dailyTipTab');
            const historyMainTab = document.getElementById('historyMainTab');
            const horizontalTabButtons = document.querySelectorAll('#horizontalTabs .tab-button');


            // Form specific elements (inside modals)
            const plantNameNicknameInput = document.getElementById('plantNameNickname');
            const generateNicknameButton = document.getElementById('generateNicknameButton');
            const imageUploadInput = document.getElementById('imageUpload');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            const identifyPlantButton = document.getElementById('identifyPlantButton');
            const plantNameInfoInput = document.getElementById('plantNameInfo');
            const getPlantInfoButton = document.getElementById('getPlantInfoButton'); 
            const schedulePlantNameInput = document.getElementById('schedulePlantName');
            const careFrequencySelect = document.getElementById('careFrequency');
            const generateCareScheduleButton = document.getElementById('generateCareScheduleButton');
            const plantNameTroubleshootInput = document.getElementById('plantNameTroubleshoot');
            const plantProblemTextarea = document.getElementById('plantProblem');
            const solvePlantProblemButton = document.getElementById('solvePlantProblemButton');

            const aiResponseArea = document.getElementById('aiResponseArea');
            const aiResponseContent = document.getElementById('aiResponseContent');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorIndicator = document.getElementById('errorIndicator');
            
            const historyList = document.getElementById('historyList'); 
            const emptyHistoryMessage = document.getElementById('emptyHistoryMessage'); 
            const clearHistoryButton = document.getElementById('clearHistoryButton'); 

            // --- توابع تاریخچه ---
            function saveHistory() {
                localStorage.setItem('plantCareHistory', JSON.stringify(history));
                renderHistory();
            }

            function addHistoryItem(question, response, section) {
                const timestamp = new Date().toLocaleString('fa-IR', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });
                history.unshift({ question, response, section, timestamp }); 
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                saveHistory();
            }

            function renderHistory() {
                historyList.innerHTML = ''; 
                if (history.length === 0) {
                    emptyHistoryMessage.style.display = 'block';
                    clearHistoryButton.style.display = 'none';
                } else {
                    emptyHistoryMessage.style.display = 'none';
                    clearHistoryButton.style.display = 'block';
                    history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.innerHTML = `
                            <p class="history-item-question"><strong>${item.section}:</strong> ${item.question}</p>
                            <p class="history-item-response"><strong>پاسخ:</strong> ${item.response}</p>
                            <p class="text-xs text-gray-500 mt-2 text-left">${item.timestamp}</p>
                        `;
                        historyList.appendChild(div);
                    });
                }
            }

            function clearAllHistory() {
                history = [];
                saveHistory();
                showMessageBox('تاریخچه پاک شد.', 'info');
            }

            // --- توابع کمکی ---
            function showMessageBox(message, type = 'info') {
                clearTimeout(messageBoxTimeout);
                messageBoxText.textContent = message;
                messageBox.classList.remove('bg-red-600', 'bg-yellow-600', 'bg-blue-600', 'animate-fade-in-down');
                
                if (type === 'error') messageBox.classList.add('bg-red-600');
                else if (type === 'warning') messageBox.classList.add('bg-yellow-600');
                else messageBox.classList.add('bg-blue-600');
                
                messageBox.style.display = 'block';
                void messageBox.offsetWidth; 
                messageBox.classList.add('animate-fade-in-down');

                if (type !== 'error') {
                   messageBoxTimeout = setTimeout(hideMessageBox, 5000);
                }
            }

            function hideMessageBox() {
                messageBox.style.display = 'none';
                messageBox.classList.remove('animate-fade-in-down');
            }

            function setLoadingState(isLoading) {
                loading = isLoading;
                loadingIndicator.style.display = isLoading ? 'flex' : 'none';
                
                const allButtons = document.querySelectorAll('#mainModalContent button, .nav-button, #horizontalTabs .tab-button');
                allButtons.forEach(btn => btn.disabled = isLoading);
            }

            function setErrorState(errorMessage) {
                if (errorMessage) {
                    errorIndicator.textContent = `خطا: ${errorMessage}`;
                    errorIndicator.style.display = 'block';
                } else {
                    errorIndicator.style.display = 'none';
                }
            }
            
            function clearInputsAndResponse() {
                plantNameNicknameInput.value = '';
                imageUploadInput.value = ''; 
                imagePreview.src = '#';
                imagePreviewContainer.style.display = 'none';
                imageDataBase64 = null;
                plantNameInfoInput.value = '';
                schedulePlantNameInput.value = '';
                careFrequencySelect.value = 'هفتگی';
                plantNameTroubleshootInput.value = '';
                plantProblemTextarea.value = '';
                aiResponseContent.innerHTML = '';
                aiResponseArea.style.display = 'none';
                setErrorState(''); 
            }

            // --- Modal Management ---
            function showModal(modalElement, contentElement, titleElement, sectionId, fullTitle) {
                clearInputsAndResponse();
                aiResponseArea.style.display = 'none'; 

                if (titleElement) { 
                    titleElement.innerHTML = `<img src="./images/response-lightbulb-icon.png" alt="آیکون پاسخ" class="w-7 h-7"> ${fullTitle}`;
                }

                const currentContentInModal = modalContentArea.firstElementChild;
                if (currentContentInModal) {
                    currentContentInModal.style.display = 'none'; 
                    currentContentInModal.classList.add('section-content-hidden-source'); 
                    if (currentContentInModal.parentNode === modalContentArea) { 
                       document.body.appendChild(currentContentInModal); 
                    }
                }
                modalContentArea.innerHTML = ''; 

                const sectionContentToShow = contentSections[sectionId];
                if (sectionContentToShow) {
                    if(sectionContentToShow.parentNode !== modalContentArea) { 
                       modalContentArea.appendChild(sectionContentToShow);
                    }
                    sectionContentToShow.classList.remove('section-content-hidden-source'); 
                    sectionContentToShow.style.display = 'block'; 

                    modalElement.style.display = 'flex'; 
                    setTimeout(() => {
                        modalElement.classList.add('modal-background-fade-in');
                        contentElement.classList.remove('modal-content-animate-out');
                        contentElement.classList.add('modal-content-animate-in');
                    }, 10);
                } else if (modalElement === dailyTipModal) { 
                    modalElement.style.display = 'flex';
                    setTimeout(() => {
                        modalElement.classList.add('modal-background-fade-in');
                        contentElement.classList.remove('modal-content-animate-out');
                        contentElement.classList.add('modal-content-animate-in');
                    }, 10);
                } else {
                    console.error(`DEV_LOG: Content for section '${sectionId}' (Title: '${fullTitle}') not found in contentSections object.`);
                    showMessageBox(`محتوایی برای بخش '${fullTitle}' یافت نشد. لطفاً با پشتیبانی تماس بگیرید.`, 'error');
                }
            }

            function hideModal(modalElement, contentElement) { 
                contentElement.classList.remove('modal-content-animate-in');
                contentElement.classList.add('modal-content-animate-out');
                modalElement.classList.remove('modal-background-fade-in');
                modalElement.classList.add('modal-background-fade-out');

                setTimeout(() => {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('modal-background-fade-out');

                    const currentDisplayedSectionInModal = modalContentArea.firstElementChild;
                    if (currentDisplayedSectionInModal) {
                        currentDisplayedSectionInModal.style.display = 'none'; 
                        currentDisplayedSectionInModal.classList.add('section-content-hidden-source'); 
                        if (currentDisplayedSectionInModal.parentNode === modalContentArea) { 
                           document.body.appendChild(currentDisplayedSectionInModal); 
                        }
                    }
                    
                    modalContentArea.innerHTML = ''; 
                    currentActiveSection = null; 

                    navButtons.forEach(btn => { 
                        btn.closest('.nav-item-wrapper').querySelector('.icon-nav-button').classList.remove('active');
                    });
                }, 300); 
            }

            // --- Main Logic for Circular Nav Toggling ---
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.dataset.section;
                    const fullTitle = button.dataset.fullTitle;

                    if (currentActiveSection === sectionId && mainModal.style.display !== 'none') {
                        hideModal(mainModal, mainModalContent); 
                        return; 
                    }

                    horizontalTabButtons.forEach(btn => btn.classList.remove('active'));
                    currentActiveTab = null;
                    
                    navButtons.forEach(btn => {
                        btn.closest('.nav-item-wrapper').querySelector('.icon-nav-button').classList.remove('active');
                    });
                    
                    button.classList.add('active');
                    currentActiveSection = sectionId; 
                    showModal(mainModal, mainModalContent, modalTitle, sectionId, fullTitle);

                    if (sectionId === 'history') {
                        renderHistory(); 
                    }
                });
            });

            closeMainModalButton.addEventListener('click', () => {
                hideModal(mainModal, mainModalContent); 
            });

            // --- API Call Function ---
            async function callGeminiApi(prompt, sectionNameForHistory, imageBase64 = null) {
                setLoadingState(true);
                setErrorState('');
                aiResponseContent.innerHTML = ''; 
                aiResponseArea.style.display = 'none'; 
                                
                try {
                    const functionUrl = '/.netlify/functions/gemini-proxy'; 
                    
                    let payloadData = { prompt: prompt };
                    if (imageBase64) {
                        payloadData.imageBase64 = imageBase64;
                    }

                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadData)
                    });

                    const result = await response.json();

                    if (response.ok && result.response) { 
                        const formattedResponse = result.response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                        
                        if (currentActiveTab === 'dailyTip') { 
                            dailyTipText.innerHTML = formattedResponse;
                            if (dailyTipModal.style.display === 'none') { // Show if not already visible
                                showModal(dailyTipModal, dailyTipModalContent, null, null, null);
                            }
                        } else { // For circular nav button responses
                            aiResponseContent.innerHTML = formattedResponse;
                            aiResponseArea.style.display = 'block'; // Show the main response area
                        }
                        addHistoryItem(prompt, result.response, sectionNameForHistory);
                    } else {
                        setErrorState(`خطا از سرور: ${result.error || 'پاسخ نامشخص.'}`);
                        console.error('Netlify Function response error:', result);
                    }
                } catch (error) {
                    setErrorState(`مشکلی در برقراری ارتباط پیش آمد: ${error.message}`);
                    console.error('API call error:', error);
                } finally {
                    setLoadingState(false);
                }
            }

            // --- Event Listeners for API Calls (from modals) ---
            closeDailyTipModalButton.addEventListener('click', () => {
                hideModal(dailyTipModal, dailyTipModalContent);
            });

            generateNicknameButton.addEventListener('click', async () => {
                if (loading) return;
                const plantName = plantNameNicknameInput.value.trim();
                if (!plantName) {
                    showMessageBox('لطفاً نام گیاه را وارد کنید.', 'warning');
                    return;
                }
                // Hide modal BEFORE API call
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                const prompt = `یک نام مستعار خلاقانه و دوست‌داشتنی برای گیاهی به نام "${plantName}" پیشنهاد بده.`;
                await callGeminiApi(prompt, `نام مستعار برای ${plantName}`);
                plantNameNicknameInput.value = '';
            });

            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                        imageDataBase64 = e.target.result.split(',')[1]; 
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = '#';
                    imagePreviewContainer.style.display = 'none';
                    imageDataBase64 = null;
                }
            });

            identifyPlantButton.addEventListener('click', async () => {
                if (loading) return;
                if (!imageDataBase64) {
                    showMessageBox('لطفاً یک تصویر از گیاه آپلود کنید.', 'warning');
                    return;
                }
                 // Hide modal BEFORE API call
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                const prompt = "این عکس یک گیاه را نشان می دهد. لطفا نام گیاه را شناسایی کرده و اطلاعات مختصری درباره آن (مثلاً خانواده و زیستگاه اصلی) ارائه دهید.";
                await callGeminiApi(prompt, "شناسایی گیاه از روی عکس", imageDataBase64);
                imageUploadInput.value = ''; 
                imagePreview.src = '#';
                imagePreviewContainer.style.display = 'none';
                imageDataBase64 = null;
            });

            getPlantInfoButton.addEventListener('click', async () => {
                if (loading) return;
                const plantName = plantNameInfoInput.value.trim();
                if (!plantName) {
                    showMessageBox('لطفاً نام گیاه را وارد کنید.', 'warning');
                    return;
                }
                 // Hide modal BEFORE API call
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                const prompt = `اطلاعات جامع و مفیدی در مورد گیاه "${plantName}" ارائه دهید. شامل نحوه مراقبت، نور، آب، خاک و مشکلات رایج.`;
                await callGeminiApi(prompt, `اطلاعات درباره ${plantName}`);
                plantNameInfoInput.value = '';
            });

            generateCareScheduleButton.addEventListener('click', async () => {
                if (loading) return;
                const plantName = schedulePlantNameInput.value.trim();
                const frequency = careFrequencySelect.value;
                if (!plantName) {
                    showMessageBox('لطفاً نام گیاه را وارد کنید.', 'warning');
                    return;
                }
                 // Hide modal BEFORE API call
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                const prompt = `یک برنامه مراقبت جامع و کاربردی برای گیاه "${plantName}" با تکرار "${frequency}" (روزانه/هفتگی/دو هفته یکبار/ماهانه/فصلی) ارائه بده. شامل جزئیات آبدهی، نور، کوددهی، و سایر نیازهای مراقبتی باشد.`;
                await callGeminiApi(prompt, `برنامه مراقبت برای ${plantName} (${frequency})`);
                schedulePlantNameInput.value = '';
                careFrequencySelect.value = 'هفتگی';
            });

            solvePlantProblemButton.addEventListener('click', async () => {
                if (loading) return;
                const plantName = plantNameTroubleshootInput.value.trim();
                const problem = plantProblemTextarea.value.trim();
                if (!plantName || !problem) {
                    showMessageBox('لطفاً نام گیاه و مشکل آن را وارد کنید.', 'warning');
                    return;
                }
                // Hide modal BEFORE API call
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                const prompt = `گیاه "${plantName}" مشکل "${problem}" را دارد. لطفاً علت احتمالی این مشکل را توضیح دهید و راه حل‌های عملی برای درمان و بهبود گیاه ارائه دهید.`;
                await callGeminiApi(prompt, `عیب یابی ${plantName}: ${problem}`);
                plantNameTroubleshootInput.value = '';
                plantProblemTextarea.value = '';
            });

            clearHistoryButton.addEventListener('click', clearAllHistory);

            // --- Horizontal Tab Bar Logic ---
            dailyTipTab.addEventListener('click', async () => {
                if (loading || currentActiveTab === 'dailyTip') return;

                navButtons.forEach(btn => {
                    btn.closest('.nav-item-wrapper').querySelector('.icon-nav-button').classList.remove('active');
                });
                currentActiveSection = null; 

                dailyTipTab.classList.add('active');
                historyMainTab.classList.remove('active');
                currentActiveTab = 'dailyTip';

                aiResponseArea.style.display = 'none';
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                
                const prompt = "یک نکته یا حقیقت جالب روزانه در مورد مراقبت از گیاهان ارائه بده. یک نکته کوتاه و جذاب باشد.";
                await callGeminiApi(prompt, "نکته روزانه");
            });

            historyMainTab.addEventListener('click', () => {
                if (loading || currentActiveTab === 'history') return;

                navButtons.forEach(btn => {
                    btn.closest('.nav-item-wrapper').querySelector('.icon-nav-button').classList.remove('active');
                });
                currentActiveSection = null; 

                historyMainTab.classList.add('active');
                dailyTipTab.classList.remove('active');
                currentActiveTab = 'history';

                aiResponseArea.style.display = 'none';
                if (mainModal.style.display !== 'none') {
                    hideModal(mainModal, mainModalContent);
                }
                if (dailyTipModal.style.display !== 'none') {
                    hideModal(dailyTipModal, dailyTipModalContent);
                }

                showModal(mainModal, mainModalContent, modalTitle, 'history', 'تاریخچه گیاهان من');
                renderHistory(); 
            });

            function initializeUI() {
                dailyTipTab.classList.add('active'); 
                historyMainTab.classList.remove('active');
                currentActiveTab = 'dailyTip';

                aiResponseArea.style.display = 'none';
                mainModal.style.display = 'none';
                dailyTipModal.style.display = 'none'; 
                
                const prompt = "یک نکته یا حقیقت جالب روزانه در مورد مراقبت از گیاهان ارائه بده. یک نکته کوتاه و جذاب باشد.";
                callGeminiApi(prompt, "نکته روزانه");

                renderHistory(); 
            }
            initializeUI();


            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('SW registered: ', registration);
                        })
                        .catch(registrationError => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
        })();
    </script>
</body>
</html>
